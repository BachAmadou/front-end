env:
  global:
  - IMAGE_NAME=front-end
  - DEPLOY_BRANCHES="master"
  - AWS_REGION=us-east-2
  - secure: "MBiRtdWrfzQrcV3hFkWjIY1l/Th+p8FWB/hLkvdXwjtabQrShmxvcc5OjHVJANy+I+9EKXf+YUDPxA5GILvubORH9aXPzHWX4uvwMB6bWSFSw0b56zFPmi2OFh8daGcqB+C5Ba4uyQGm5YU8EQ6ZSj0ASUQStvj/1dyUw8wqEQSEhc3xnXHkE9xmKU8aH8ahRe5RNCn5uV3dyV/4KDdjXgp66HqLNtPQsFPe0d+5Cg6ULo3y5xaazKZSwrrjTyHbBBhB34e7pcvVVMwf737e1/fMaohlEWNFPmL02w02xkVupldeFkA4n+jrjqlKdvC/3Eae5sMZFyHvwQZUZHSHGDHUZHQlXg6kBaY9WNkZHl1b4BRHzuEw8+CfkRvY1bjETaZ78CwDpxec33yOgVu3SnVvICGdWllAofqdacg5wH3pJMC8toFT5YAmOJP+w1n1fAY7vB0minB0j/idHl8CkFLBnrSl/kj3qhd0pGoKH3sykHrL26apIliZ+8W9njYA2BSypWMuyQwVhVA6I0xQ6So5AZTmZUisVoFGusxSmbMrOAaGpUPEgCkgspWe5FmREehhE3LlO5Klab/vhEFWMb8AmrVke4fpCnMzYhm0xWWpQt9oA4zyRoub08J3yeOnYuqw8OfdN8IDVPuePRAaxdE0+ncsuHxqN4eV0vH631k="
  - secure: "HTAr1re6wF/zhUJKA8HAkzRUIzT+iEVNjUHEut/OZ9nPE8W7ss4uKW3iv3RQBWSwVZjMNQ3imzddyBUvPeUGLw4m3vnwLvkIRDYrAstbAbEOj1qU16gUtJhmKTNvijQwtllDNua6EyhuRQ4GITNq/hlIIB1esH/n2nA/u0ael7VJmULbn3tOTorzXth9Ux/OKG7GC0FW3ukiJldT9uPmL0h9NvHw+1lDdimzW58Rke1uQ0wQoexdaG7uPT4aUaQWMByMSCDGUYkeukh78yy5FJPfmopo8BL8qxSYkJLn1G2vaUzEFGcLtq7bZhiViZyT+5957dtDfql0uUnFH8sonE5GHTcxsuXi0qMAyJZoUN7Wmb/AIsi6OYK19MQyDNBbfPuyKQxcUo9MOdjaNgbMTVHFKlFNb15iP634515+OHHq1ICoWM8Npz+PPr/iyRoBvQfryl8utS5njQlEzC/7eNPG9mH6hDxtysYrGpoIUUD8NVlWsUN3GVWeEZEEF8DaRQ2LS2YQqY1hmrVt6lGAeR5qQ4xOlv3oD9xiVXPF9lyI3oqwhloHDUARzxHisqk/s3PckwA7elrJT6oewb5xX8bNkV+Gf1ufP0oTUn/3Q8MDnm5/Wta488HsV/OJYNQDwILmpp59MZGMuoyCdZI0dlpvEDPI4s5EHErUyyzSBQI="
  - REMOTE_IMAGE_URL=633607774026.dkr.ecr.us-east-2.amazonaws.com/front-end

# node_js: # not needed - `.nvmrc` at root-level

cache:
  yarn: true
  directories:
    - 'node_modules'

before_install:
  - curl -o- -L https://yarnpkg.com/install.sh | bash -s -- --version 1.12.1
  - export PATH="$HOME/.yarn/bin:$PATH"
  - yarn global add greenkeeper-lockfile@2

install:
  - yarn --silent

before_script:
  - greenkeeper-lockfile-update
  - curl -L https://codeclimate.com/downloads/test-reporter/test-reporter-latest-linux-amd64 > ./cc-test-reporter
  - chmod +x ./cc-test-reporter
  - ./cc-test-reporter before-build

script:
  - yarn lint
  - yarn test:ci
  - yarn build

# Leave comment for inevitable Cypress integration
# jobs:
#   include:
# THIS IS ONE STAGE
#     - stage: lint/test
#       name: "Lint"
#       script: yarn lint
#     -
#       name: "Test"
#       script: yarn test:ci
# THIS IS ANOTHER
#     - stage: build
#       name: "Build"
#       script: yarn build

after_script:
  - greenkeeper-lockfile-upload
  - ./cc-test-reporter after-build --exit-code $TRAVIS_TEST_RESULT

deploy:
  - provider: script
    script: echo 'No build on feature branches. @zeit/now deploys static exports automatically.'
    skip_cleanup: true
    on:
      all_branches: true
      master: false
  - provider: script
    script: yarn add now && now --local-config=./now.master.json --token $NOW_TOKEN && now alias --local-config=./now.master.json --token $NOW_TOKEN
    skip_cleanup: true
    on:
      all_branches: false
      master: true
  - provider: script
    script: bash bin/ecr_publish && bin/k8s_config_deploy
    on:
      master: true
